<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تسجيل حضور الموظف</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center px-4">

  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold text-center text-blue-600 mb-4">تسجيل الحضور</h1>

    <label class="block mb-2 text-gray-700 font-medium">اسم الموظف:</label>
    <input id="nameInput" type="text" placeholder="اكتب اسمك هنا"
           class="w-full border px-4 py-2 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-400"/>

    <video id="video" autoplay playsinline class="w-full rounded mb-4"></video>

    <button id="captureBtn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded">
      تسجيل الحضور
    </button>

    <p id="status" class="text-red-600 text-sm mt-3 font-semibold text-center"></p>
    <p id="success" class="text-green-600 text-sm mt-3 font-semibold text-center"></p>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const officeLat = 26.435998;
    const officeLng = 50.087908;
    const allowedDistance = 50;

    const nameInput = document.getElementById("nameInput");
    const video = document.getElementById("video");
    const captureBtn = document.getElementById("captureBtn");
    const status = document.getElementById("status");
    const success = document.getElementById("success");

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        status.textContent = "❌ تعذر تشغيل الكاميرا: " + err.message;
        captureBtn.disabled = true;
      }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      function toRad(deg) { return deg * Math.PI / 180; }
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function captureImage() {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      return canvas.toDataURL("image/jpeg");
    }

    function getLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve(pos.coords),
          err => reject(err),
          { enableHighAccuracy: true }
        );
      });
    }

    async function handleAttendance() {
      status.textContent = "";
      success.textContent = "";

      const name = nameInput.value.trim();
      if (!name) {
        status.textContent = "⚠️ يرجى إدخال الاسم";
        return;
      }

      let coords;
      try {
        coords = await getLocation();
      } catch (err) {
        status.textContent = "❌ تعذر تحديد الموقع: " + err.message;
        return;
      }

      const distance = getDistance(officeLat, officeLng, coords.latitude, coords.longitude);
      if (distance > allowedDistance) {
        status.textContent = `❌ خارج موقع العمل (${Math.round(distance)} متر)`;
        return;
      }

      const photo = captureImage();
      const timestamp = new Date().toISOString();

      try {
        await db.collection("attendance").add({
          name,
          photo,
          latitude: coords.latitude,
          longitude: coords.longitude,
          timestamp
        });
        success.textContent = "✅ تم تسجيل الحضور بنجاح!";
        nameInput.value = "";
      } catch (err) {
        status.textContent = "❌ خطأ في رفع البيانات: " + err.message;
      }
    }

    captureBtn.addEventListener("click", handleAttendance);
    startCamera();
  </script>
</body>
</html>

