<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>تسجيل حضور الموظف</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
  label, input, button { display: block; margin: 10px 0; width: 100%; max-width: 400px; }
  button { padding: 10px; font-size: 16px; cursor: pointer; }
  #status { font-weight: bold; margin-top: 15px; }
  video { max-width: 320px; border-radius: 8px; }
</style>
</head>
<body>

<h2>تسجيل حضور الموظف بالصورة والموقع</h2>
<label for="nameInput">اسم الموظف:</label>
<input type="text" id="nameInput" placeholder="اكتب اسمك" autocomplete="off" />

<video id="video" autoplay playsinline width="320" height="240"></video>
<button id="btnCapture">تسجيل الحضور</button>

<p id="status"></p>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDk7Y-FS3tPBCYB8UPzvLnODMocV-iHLQI",
    authDomain: "attendance-1cbdf.firebaseapp.com",
    projectId: "attendance-1cbdf",
    storageBucket: "attendance-1cbdf.firebasestorage.app",
    messagingSenderId: "428674326610",
    appId: "1:428674326610:web:25f46045e210bd362d3f8b"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const officeLat = 26.435998;
  const officeLng = 50.087908;
  const allowedDistanceMeters = 50;

  const video = document.getElementById("video");
  const btnCapture = document.getElementById("btnCapture");
  const status = document.getElementById("status");
  const nameInput = document.getElementById("nameInput");

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (e) {
      status.textContent = "تعذر الوصول إلى الكاميرا: " + e.message;
      btnCapture.disabled = true;
    }
  }

  function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
    function deg2rad(deg) { return deg * (Math.PI / 180); }
    const R = 6371000;
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
      Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function capturePhoto() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);
    return canvas.toDataURL("image/png");
  }

  function getLocation() {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("المتصفح لا يدعم تحديد الموقع"));
      } else {
        navigator.geolocation.getCurrentPosition(
          pos => resolve(pos.coords),
          err => reject(err),
          { enableHighAccuracy: true, timeout: 10000 }
        );
      }
    });
  }

  async function recordAttendance() {
    const name = nameInput.value.trim();
    if (!name) {
      status.textContent = "يرجى إدخال الاسم أولاً";
      return;
    }

    status.textContent = "جارٍ الحصول على الموقع...";
    let coords;
    try {
      coords = await getLocation();
    } catch(e) {
      status.textContent = "تعذر الحصول على الموقع: " + e.message;
      return;
    }

    const distance = getDistanceFromLatLonInMeters(
      officeLat, officeLng,
      coords.latitude, coords.longitude
    );

    if (distance > allowedDistanceMeters) {
      status.textContent = `أنت خارج نطاق الموقع المسموح (المسافة: ${Math.round(distance)} متر)`;
      return;
    }

    status.textContent = "جارٍ التقاط الصورة وتحميلها...";

    const photoBase64 = capturePhoto();
    const timestamp = new Date();

    try {
      await db.collection("attendance").add({
        name: name,
        photo: photoBase64,
        timestamp: timestamp.toISOString(),
        latitude: coords.latitude,
        longitude: coords.longitude
      });
      status.textContent = `تم تسجيل الحضور بنجاح في ${timestamp.toLocaleString()}`;
      nameInput.value = "";
    } catch (err) {
      status.textContent = "خطأ في التسجيل: " + err.message;
    }
  }

  btnCapture.addEventListener("click", recordAttendance);
  startCamera();
</script>

</body>
</html>
