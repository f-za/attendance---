<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>لوحة تحكم الحضور</title>
<style>
  body { font-family: Arial, sans-serif; background: #f7f9fc; padding: 20px; }
  table { border-collapse: collapse; width: 100%; background: white; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #2196F3; color: white; }
  img { max-width: 80px; border-radius: 8px; }
  #logout { background-color: #f44336; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; margin-bottom: 20px; }
  #logout:hover { background-color: #d32f2f; }
  #filter { margin-bottom: 10px; padding: 8px; width: 300px; }
</style>
</head>
<body>

<h2>لوحة تحكم الحضور</h2>
<button id="logout">تسجيل خروج</button>
<input type="text" id="filter" placeholder="ابحث بالاسم..." />

<table id="attendance-table">
  <thead>
    <tr>
      <th>الصورة</th>
      <th>الاسم</th>
      <th>التاريخ والوقت</th>
      <th>الموقع</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const logoutBtn = document.getElementById('logout');
  const tableBody = document.querySelector('#attendance-table tbody');
  const filterInput = document.getElementById('filter');

  logoutBtn.addEventListener('click', () => {
    auth.signOut().then(() => {
      window.location.href = 'index.html';
    });
  });

  auth.onAuthStateChanged(user => {
    if (!user) {
      window.location.href = 'index.html';
    } else {
      loadAttendance();
    }
  });

  function loadAttendance() {
    db.collection("attendance").orderBy("timestamp", "desc").onSnapshot(snapshot => {
      tableBody.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const date = new Date(data.timestamp).toLocaleString('ar-EG');
        const mapLink = `https://www.google.com/maps?q=${data.latitude},${data.longitude}`;
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td><img src="${data.photo}" alt="صورة الحضور" /></td>
          <td>${data.name}</td>
          <td>${date}</td>
          <td><a href="${mapLink}" target="_blank">عرض الموقع</a></td>
        `;

        tableBody.appendChild(tr);
      });
    });
  }

  filterInput.addEventListener('input', () => {
    const filter = filterInput.value.toLowerCase();
    [...tableBody.rows].forEach(row => {
      const name = row.cells[1].textContent.toLowerCase();
      row.style.display = name.includes(filter) ? '' : 'none';
    });
  });
</script>

</body>
</html>
